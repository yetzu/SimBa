# 代码结构说明

本项目采用模块化架构设计，基于 PyTorch 和 PyTorch Lightning 框架开发。项目核心为 metai 算法包，支持 MetMamba（时空状态空间模型）与 SimVP（基座对比模型）的训练、推理与评估。

---

## 目录结构概览

```plaintext
code_package.zip
├── code/                              # [代码] 完整项目代码目录
│   ├── data/                          # [资源] 数据资源目录，存放数据集的索引文件
│   │   ├── samples.jsonl              # 训练集样本索引文件（JSON Lines格式），每一行记录一个训练样本的路径和元数据
│   │   └── samples.testset.jsonl      # 测试集样本索引文件，用于推理和测试阶段读取数据
│   ├── metai/                         # [核心] 核心算法包，包含所有模型、数据加载和工具类的源代码
│   │   ├── dataset/                   # 数据处理模块，负责数据的读取、封装和增强
│   │   │   ├── __init__.py            # Python 包初始化文件
│   │   │   ├── met_case.py            # 定义“气象个例”(Case)类，用于管理单次强对流过程的多帧雷达与NWP数据
│   │   │   ├── met_dataloader_scwds.py # 定义 PyTorch DataModule，负责构建训练、验证、测试的 DataLoader
│   │   │   └── met_sample.py          # 定义样本生成逻辑，实现滑动窗口切片，将时间序列转换为(输入, 目标)样本对
│   │   ├── model/                     # 模型定义模块
│   │   │   ├── core/                  # 通用核心组件，供不同模型共用
│   │   │   │   ├── __init__.py        # 包初始化文件
│   │   │   │   ├── optim_constant.py  # 优化器相关的常量定义
│   │   │   │   └── optim_scheduler.py # 自定义学习率调度器（如 Cosine Annealing, Warmup）
│   │   │   ├── mamba/                 # MetMamba 模型的核心实现目录
│   │   │   │   ├── __init__.py        # 包初始化文件
│   │   │   │   ├── config.py          # 模型配置类(ModelConfig)，定义输入形状、层数、学习率等超参数
│   │   │   │   ├── loss.py            # 定义组合损失函数 (L1 + SSIM + CSI + Spectral Loss)
│   │   │   │   ├── metrices.py        # 评估指标计算代码（如 CSI, HSS 等）
│   │   │   │   ├── model.py           # MetMamba 网络架构定义，包含空间编码器与时序演变模块
│   │   │   │   ├── module.py          # PyTorch Lightning Module 封装，定义训练步长(training_step)与验证逻辑
│   │   │   │   └── trainer.py         # Mamba 模型的专用训练器逻辑封装
│   │   │   └── simvp/                 # SimVP (对比基线模型) 的核心实现目录
│   │   │       ├── layers/            # SimVP 的空间特征提取层(Backbones)
│   │   │       │   ├── __init__.py    # 包初始化文件
│   │   │       │   ├── hornet.py      # HorNet 骨干网络实现
│   │   │       │   ├── moganet.py     # MogaNet 骨干网络实现
│   │   │       │   ├── poolformer.py  # PoolFormer 骨干网络实现
│   │   │       │   ├── uniformer.py   # UniFormer 骨干网络实现
│   │   │       │   └── van.py         # VAN (Visual Attention Network) 骨干网络实现
│   │   │       ├── __init__.py        # 包初始化文件
│   │   │       ├── simvp_config.py    # SimVP 模型配置类
│   │   │       ├── simvp_loss.py      # SimVP 专用损失函数
│   │   │       ├── simvp_model.py     # SimVP 通用网络架构实现
│   │   │       ├── simvp_module.py    # SimVP 的 PyTorch Lightning Module 封装
│   │   │       └── simvp_trainer.py   # SimVP 的专用训练器接口
│   │   ├── utils/                     # [工具] 通用工具库
│   │   │   ├── __init__.py            # 包初始化文件
│   │   │   ├── met_config.py          # 配置解析工具，负责加载 config.yaml 并合并命令行参数
│   │   │   ├── met_log.py             # 全局日志记录工具，统一日志格式
│   │   │   ├── met_os.py              # 操作系统交互工具，处理文件路径和目录创建
│   │   │   └── met_var.py             # 气象变量处理工具，包含物理量计算(如dBZ)和归一化/反归一化方法
│   │   ├── __init__.py                # 包初始化文件
│   │   └── config.yaml                # [全局配置] 项目的基础配置文件，定义根目录路径、文件前缀等全局参数
│   ├── prework/                       # [预处理] 数据工程脚本目录
│   │   ├── step1_create_gisifno.py    # 步骤1：生成地理信息数据（经纬度、DEM等）
│   │   ├── step2_create_train_cases.py # 步骤2：扫描原始数据，构建训练个例列表
│   │   ├── step3_stat_train_cases.py  # 步骤3：统计训练集数据的分布特性（均值、方差），用于数据归一化
│   │   ├── step4_create_samples.py    # 步骤4：根据个例生成训练样本的元数据索引
│   │   ├── step5_create_testset_samples.py # 步骤5：生成测试集的样本元数据索引
│   │   └── step6_export_dataset_to_npz.py  # 步骤6：将零散的数据文件打包为 .npz 格式，以提高 I/O 效率
│   ├── run/                           # [执行] Python 执行脚本目录
│   │   ├── simvp/                     # SimVP 模型相关执行脚本
│   │   │   ├── infer_scwds_simvp.py   # SimVP 模型推理脚本，生成可视化结果
│   │   │   ├── infer_scwds_simvp_gpm.py # SimVP 模型针对 GPM 数据集的推理适配脚本
│   │   │   ├── test_scwds_simvp.py    # SimVP 模型测试脚本，计算性能指标
│   │   │   └── train_scwds_simvp.py   # SimVP 模型训练入口脚本
│   │   ├── infer_scwds_mamba.py       # Mamba 模型推理脚本，生成可视化结果
│   │   ├── test_scwds_mamba.py        # Mamba 模型测试脚本，评估模型性能
│   │   └── train_scwds_mamba.py       # Mamba 模型训练入口脚本，解析参数并启动训练
│   ├── test/                          # [测试] 单元测试与功能验证脚本
│   │   ├── test.sh                    # 批量运行测试的 Shell 脚本
│   │   ├── test_met_config.py         # 测试配置加载功能
│   │   ├── test_met_os.py             # 测试文件系统操作功能
│   │   ├── test_met_sample.py         # 测试样本生成逻辑
│   │   ├── test_met_scwds.py          # 测试数据集加载功能
│   │   ├── test_met_var.py            # 测试气象变量处理功能
│   │   ├── test_plot_frames_full.py   # 测试绘图功能：绘制完整的时序序列
│   │   └── test_plot_frames_single.py # 测试绘图功能：绘制单帧图像
│   ├── tmp/                           # [临时] 临时文件夹
│   ├── submit_tools/                  # [提交]竞赛提交打包工具代码
│   │   ├── jupyterlab_config.json     # 线上环境 JupyterLab 的配置文件
│   │   ├── submission_history.json    # 记录历史提交版本与分数的日志文件
│   │   └── upload.py                  # 提交脚本，官方提供，用于将预测结果按竞赛要求格式提交
│   ├── requirements.txt               # [依赖] Python 依赖包清单
│   ├── run.scwds.mamba.sh             # [入口] MetMamba 模型一键控制脚本 (可作为 main 入口)
│   └── run.scwds.simvp.sh             # [入口] SimVP 模型一键控制脚本
├── doc/                               # [文档] 文档目录（必需）
│   ├── README.md                      # [说明] 项目主说明文档 (原根目录文件)
│   ├── install.md                     # 环境安装与依赖配置指南
│   └── struct.md                      # 项目结构说明文档
└── submit/                            # [结果] 提交结果目录
    ├── TestA/                         # A榜测试结果目录
    │   └── result.npy                 # 结果文件（按赛道类型，示例占位）
    └── TestB/                         # B榜测试结果目录
        └── result.npy                 # 结果文件（按赛道类型，示例占位）
```

---

## 核心模块详解

### metai（核心算法库）

`metai` 是项目核心，采用面向对象设计，针对气象数据特性定制化开发，覆盖数据处理、模型实现、通用工具三大核心能力。

#### 数据层 (`metai/dataset`)

针对气象雷达数据 **“高维 (Time, Channel, Height, Width)、稀疏、时序连续”** 的特点设计，解决数据加载与样本构建问题：

* **`met_case.py`**: 定义 **“气象个例 (Case)”** 抽象类。一个 Case 对应一次完整的强对流天气过程，封装该过程的所有连续雷达回波帧、NWP 辅助数据等。
* **`met_sample.py`**: 实现滑动窗口切片逻辑。将连续的 Case 时序数据切分为 `(输入帧序列, 目标帧序列)` 样本对（如输入 10 帧预测 10 帧）。
* **`met_dataloader_scwds.py`**: 继承 PyTorch Lightning `LightningDataModule`，自动完成：
* 训练 / 验证 / 测试集的划分；
* 多进程数据加载（基于 NumPy Memmap 优化大规模数据读取）；
* 动态 Batch 组装与数据增强。

#### 模型层 (`metai/model`)

支持双流模型架构：MetMamba（核心模型）与 SimVP（基线模型），满足对比验证与性能迭代需求。

**A. MetMamba 模块 (`metai/model/mamba`)**
专为气象雷达回波外推降水任务优化的时空状态空间模型 (SSM)：

* **`model.py`**: 核心网络架构。融合视觉骨干网络的空间特征提取能力与 Mamba 的长时序建模能力，适配雷达回波的时空演变特性。
* **`loss.py`**: 定制化组合损失函数，兼顾数值精度与气象业务指标：
其中 L_{CSI} (Critical Success Index Loss) 专门优化高回波（强对流）区域的预测准确率。
* **`metrices.py`**: 实现气象业务核心评估指标（CSI、HSS、FAR、POD 等），贴合实际业务场景。
* **`module.py`**: PyTorch Lightning Module 封装。定义 `training_step`, `validation_step`, `test_step` 等核心流程，集成 AdamW 优化器 + CosineAnnealing 学习率调度器。
* **`trainer.py`**: MetMamba 专用训练器封装。支持断点续训、多卡训练、日志记录等功能。

**B. SimVP 基线模块 (`metai/model/simvp`)**
集成多种 SOTA 视觉骨干网络的基准模型，用于性能对比验证：

* **`layers/`**: 提供 HorNet, VAN, PoolFormer, MogaNet, UniFormer 等主流视觉骨干网络，支持灵活替换。
* **`simvp_model.py`**: 实现标准 SimVP 网络架构，适配雷达回波的时空预测任务。
* **`simvp_module.py`**: SimVP 的 PyTorch Lightning Module 封装，与 MetMamba 保持统一的训练/验证接口。
* **`simvp_loss.py`**: SimVP 专用损失函数，适配基线模型的优化需求。

#### 工具层 (`metai/utils`)

提供气象领域专用工具，保障数据处理与模型运行的通用性和鲁棒性：

* **`met_var.py`**: 气象物理量处理核心，实现：
* 雷达反射率因子 (dBZ) 与像素值 (0-255) 的双向转换；
* 基于训练集统计的 Z-Score 归一化/反归一化（均值/方差来自 `prework` 阶段的统计结果）。

* **`met_config.py`**: 配置解析工具。支持 YAML 配置文件与命令行参数的深度合并，统一参数管理。
* **`met_log.py`**: 全局日志工具。标准化日志格式，支持训练/推理过程的日志分级记录。
* **`met_os.py`**: 文件系统交互工具。封装路径拼接、目录创建、文件读写等通用操作，适配多平台环境。

---

### rework（数据预处理）

针对大规模气象数据设计标准化 6 步预处理流程，解决原始数据离散、IO 效率低的问题：

* **`step1_create_gisifno.py` (地理信息生成)**: 生成经纬度、DEM（数字高程模型）等地理辅助信息，补充空间特征。
* **`step2_create_train_cases.py` (训练个例构建)**: 扫描原始雷达/NWP 数据，将离散的时间帧组织为连续的“气象个例”。
* **`step3_stat_train_cases.py` (数据分布统计)**: 遍历训练集，计算各气象变量的均值、方差，为归一化提供依据。
* **`step4_create_samples.py` (训练样本切片)**: 基于滑动窗口生成训练样本的元数据索引 (`samples.jsonl`)。
* **`step5_create_testset_samples.py` (测试集准备)**: 生成测试集的样本元数据索引 (`samples.testset.jsonl`)。
* **`step6_export_dataset_to_npz.py` (IO 优化)**: 将零散的小文件打包为 `.npz` 格式，大幅降低训练时的文件系统 IOPS 开销。

---

### run（执行脚本）

提供模型训练、测试、推理的入口脚本，接口统一且易用：

* **训练脚本**: `train_scwds_mamba.py` / `train_scwds_simvp.py`
* 读取配置文件，初始化 DataModule 与模型，启动 PyTorch Lightning Trainer，支持断点续训。

* **测试脚本**: `test_scwds_mamba.py` / `test_scwds_simvp.py`
* 加载训练好的最佳权重 (`best.ckpt`)，在测试集上计算 CSI、HSS 等核心指标，输出性能报告。

* **推理脚本**: `infer_scwds_mamba.py` / `infer_scwds_simvp.py`
* 端到端执行预测，生成可视化结果（如雷达回波时序预测图），存入 `output/vis_infer` 目录。

* **一键控制脚本**: `run.scwds.mamba.sh` / `run.scwds.simvp.sh`
* 封装训练/测试/推理的完整流程，作为项目主入口，简化命令行操作。

---

### test（测试模块）

提供单元测试与功能验证脚本，保障核心模块的正确性：

* **基础工具测试**:
* `test_met_config.py` (配置加载)
* `test_met_os.py` (文件操作)
* `test_met_var.py` (气象变量处理)

* **数据层测试**:
* `test_met_sample.py` (样本生成)
* `test_met_scwds.py` (数据集加载)

* **可视化测试**:
* `test_plot_frames_full.py` (完整时序绘图)
* `test_plot_frames_single.py` (单帧绘图)

* **批量测试脚本**:
* `test.sh`: 一键运行所有测试用例，快速验证模块功能。

---

### submit（结果提交）

适配竞赛提交规范的结果存储目录：

* **`TestA/` / `TestB/**`: 分别存放 A 榜、B 榜的测试结果文件 (`result.npy`)，符合竞赛提交格式要求。
* **`submit_tools/`**: 提供提交辅助工具，简化结果提交流程：
* `jupyterlab_config.json`: 线上环境配置
* `submission_history.json`: 提交历史记录
* `upload.py`: 官方提交脚本

---

### doc（文档目录）

提供完整的项目文档，保障可维护性与易用性：

* **`README.md`**: 项目主说明文档（背景、功能、快速启动）。
* **`install.md`**: 环境安装与依赖配置指南（Python 环境、依赖包）。
* **`struct.md`**: 项目结构说明文档（目录/文件功能解析）。
