
# 开发环境说明

本项目基于 Python 3.11 和 PyTorch 构建，使用 Linux 环境并配合 CUDA 12.1 进行加速。

## 核心依赖
* **Python**: 3.11
* **CUDA Toolkit**: 12.1
* **深度学习框架**:
    * `torch`, `torchvision`, `torchaudio` 
    * `lightning` (PyTorch Lightning)
    * `timm`
    * `mamba-ssm` (核心算子，需单独编译)
    * `pytorch-msssim`
* **科学计算与图像处理**:
    * `pandas`, `scipy`, `matplotlib`, `seaborn`
    * `opencv`
    * `rasterio`, `cartopy`
* **工具库**:
    * `jsonargparse`, `PyYAML`, `pytest`

具体环境依赖详见`requirements.txt`

## 设置镜像

```bash
conda config --add channels defaults
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch
conda config --set show_channel_urls yes
conda config --show channels

pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

## 安装命令

```bash
# 创建环境
conda create -n metai python=3.11
conda activate metai

# 安装系统级依赖
conda install gxx_linux-64 cuda-toolkit=12.1 -y
conda install pytest pandas matplotlib scipy opencv PyYAML seaborn pydantic cartopy rasterio -y

# 安装 Python 库
pip install torch torchvision torchaudio tensorboard timm pytorch-msssim lpips deepspeed
pip install lightning lightning-utilities 
pip install -U "jsonargparse[signatures]>=4.18.0"

# 安装 mamba-ssm 库
# pip install mamba-ssm==2.2.6.post3

# 竞赛服务器无法直接安装mamba_ssm，需编译

# 下载源码包到本地并提交评测系统
wget https://github.com/state-spaces/mamba/archive/refs/tags/v2.2.6.post3.tar.gz

# 提交评测系统略

mkdir mamba_build_temp
cd mamba_build_temp
# 解压源码包 (路径需根据实际情况调整)
tar -xzf mamba_ssm-2.2.6.post3.tar.gz
cd mamba_ssm-2.2.6.post3/
export FORCE_BUILD=1
python setup.py install
pip install mamba-ssm
```

## 运行时环境优化

项目运行需要设置特定的环境变量以优化显存和通信。建议将以下内容写入启动脚本或 ~/.bashrc

```bash
# 将当前目录加入 PYTHONPATH，确保模块可导入
export PYTHONPATH=$PYTHONPATH:$(pwd)

# 优化 PyTorch 显存分配策略，避免显存碎片化
export PYTORCH_ALLOC_CONF=expandable_segments:True

# NCCL 分布式通信配置
export NCCL_P2P_DISABLE=1
export NCCL_IB_DISABLE=0
export NCCL_DEBUG=WARN
```