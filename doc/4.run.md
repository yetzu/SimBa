# 运行说明

本项目的执行流程分为 `数据预处理`、`模型训练`、`性能测试` 与 `推理可视化` 四个阶段。所有核心操作均已封装为 Shell 脚本，自动处理环境变量与依赖路径。

---

##  预处理

本项目针对竞赛数据（高维、稀疏、时序）设计了标准化的 6 步预处理流程 (prework/)，旨在解决数据清洗、 IO 瓶颈及归一化处理等问题。

以下是整理后的 Markdown 表格：

| 步骤 | 脚本文件 | 功能说明 |
| ---- | ---- | ---- |
| Step 1 | step1_create_gisifno.py | 生成地理辅助信息（经纬度、DEM），用于补充空间特征。 |
| Step 2 | step2_create_train_cases.py | 个例构建：扫描原始数据，将离散帧组织为连续的“气象个例 (Case)”。 |
| Step 3 | step3_stat_train_cases.py | 分布统计：计算全局均值与方差，用于后续 Z-Score 归一化。 |
| Step 4 | step4_create_samples.py | 样本切片：基于滑动窗口生成训练样本索引 (samples.jsonl)，定义输入/目标对。 |
| Step 5 | step5_create_testset_samples.py | 生成测试集样本索引 (samples.testset.jsonl)。 |
| Step 6 | step6_export_dataset_to_npz.py | IO 优化：将零散文件打包为 .npz，降低文件系统 IOPS 开销。 |


执行方法

```bash
python prework/step...
```

---

## 模型训练

项目包含两个版本的模型架构。训练脚本会自动配置 DDP 分布式训练、混合精度 (Mixed Precision) 及 梯度累积 策略,可以通过 Shell 脚本一键启动。

### V1: SimVP 基线模型 (CNN-based)

基于 run.scwds.simvp.sh 脚本启动。该模型采用 BF16 混合精度训练，使用 AdamW 优化器。

启动命令:

```bash
bash run.scwds.simvp.sh train
```

### V2: MetMamba 核心模型 (SSM-based)

基于 run.scwds.mamba.sh 脚本启动。这是本项目的核心物理驱动模型，针对长时序依赖进行了优化。

启动命令:

```bash
bash run.scwds.mamba.sh train
```

## 模型测试

### V1: SimVP 测试

测试命令:

```bash
bash run.scwds.simvp.sh test
```

### V2 MetMamba 测试

测试命令:

```bash
bash run.scwds.mamba.sh test
```

## 模型推理与后处理

推理阶段将生成未来时刻的雷达回波预测图，并自动保存可视化结果。

### 常规推理

执行端到端推理，输出预测结果及可视化对比图（GT vs Pred）。

```bash
# V1 SimVP 推理
bash run.scwds.simvp.sh infer

# V2 MetMamba 推理
bash run.scwds.mamba.sh infer
```

可视化: 脚本默认开启 --vis 参数，结果保存在 ./output/*/vis_infer。

### 增强推理 (Soft-GPM)
针对 SimVP 模型，提供基于 Soft-GPM (Gaussian Process Model) 的后处理增强模式，用于平滑预测结果并减少模糊度。

```bash
bash run.scwds.simvp.sh infer_gpm
```

关键参数:
--gpm_alpha 0.7: GPM 融合系数。
--gpm_decay 0.9: 衰减系数。

## 提交结果复现

### 测试集A

- 修改`samples.testset.jsonl`

```bash
bash run.scwds.simvp.sh infer_gpm
```

### 测试集B

- 修改`samples.testset.jsonl`

```bash
bash run.scwds.simvp.sh infer_gpm
```


